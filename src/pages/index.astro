---
import { getEntry } from "astro:content";
import Layout from "./_layout.astro";

// Opt-out pre-rendering
export const prerender = false;

let today = new Date();

// Get current dateTime based on userâ€™s ipAddress
const ip = Astro.request.headers.get("x-real-ip");

if (ip) {
  try {
    const response = await fetch(
      `https://timeapi.io/api/Time/current/ip?ipAddress=${ip}`,
      { headers: { accept: "application/json" } },
    );

    const { dateTime } = (await response.json()) as { dateTime: string };
    today = new Date(dateTime);
  } catch (error) {
    console.error(error);
  }
}

// Get specific entry by date
const filename = [today.getMonth() + 1, today.getDate()].join("-");
const dateEntry = await getEntry("dates", filename);

if (!dateEntry) {
  return new Response(null, {
    status: 404,
    statusText: "[Date] Content not found",
  });
}
---

<Layout dateEntry={dateEntry} dateTime={today} />
